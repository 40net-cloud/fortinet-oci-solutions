# Title shown in Application Information tab.
title: FortiGate Firewall Standalone Deployment Template
# Sub Title shown in Application Information tab.
description: This template deployes two FortiGate Firewalls
schemaVersion: 1.1.0
version: "20210210"

# URL of Logo Icon used on Application Information tab. Logo must be 130x130 pixels.
# (Optional)
logoUrl: https://cloudmarketplace.oracle.com/marketplace/content?contentId=101680265

# Used in Application Information tab to Hyperlink Title and Logo to the Marketplace
# Listing.
# Also used to link to Listing Usage section for "View Instructions".
# (Optional) If it is missing, Application Information uses the
# "marketplace-listing-id" tag for the same purpose.
source:
  type: marketplace
  reference: 62460098

locale: "en"
variableGroups:
  - title: "Hidden Variable Group"
    visible: false
    variables:
      - tenancy_ocid
      - region
      - mp_listing_resource_version
      - mp_subscription_enabled
      - network_strategy_enum
      - subnet_type_enum
      - nsg_config_enum
      - template_name
      - availability_domain_number
      - template_version
      - trust_public_ip_lifetime
      - fingerprint
      - management_route_table_existing_attachment
      - mp_listing_id
      - mp_listing_resource_id
      - private_key_path
      - user_ocid
      
  - title: "FortiGate Compute Configuration"
    variables:
      - compute_compartment_ocid
      - vm_flex_shape_ocpus
      - availability_domain_name_1
      - license_type
      - fortios_version
      - cpu_type
      - vm_compute_shape_arm
      - vm_compute_shape_x64
      - ocpu_count
      - memory_in_gbs
      - instance_launch_options_network_type

  - title: "Common Network Configuration"
    variables:
      - network_compartment_ocid
      - network_strategy
      - subnet_span
      - nsg_whitelist_ip
      - igw_ocid
      - nsg_display_name

  - title: "Firewall Hub Configuration"
    variables:
      - vm_display_name
      - vcn_id
      - vcn_display_name
      - vcn_cidr_block
      - vcn_dns_label
      - management_subnet_id
      - management_subnet_display_name
      - management_subnet_cidr_block
      - management_subnet_dns_label
      - trust_subnet_id
      - trust_subnet_display_name
      - trust_subnet_cidr_block
      - trust_subnet_dns_label
      - use_existing_ip
      - public_routetable_display_name
      - private_routetable_display_name
      - management_routetable_display_name
      - management_routetable_display_name_existing
      - trust_routetable_display_name_existing
      - trust_routetable_display_name_existing
  
  - title: "Static IP Addresses Configuration"
    variables:
      - mgmt_private_ip
      - trust_private_ip
      - mgmt_subnet_gateway
      - trust_subnet_gateway
      - volume_size

variables:
  # Hidden variables
  tenancy_ocid:
    type: string
    title: Tenancy ID
    description: The Oracle Cloud Identifier (OCID) for your tenancy
    required: true

  compute_compartment_ocid:
    type: oci:identity:compartment:id
    required: true
    title: Compartment OCID
    description: The compartment in which to create all Compute resources
    default: compartment_ocid

  network_compartment_ocid:
    type: oci:identity:compartment:id
    required: true
    title: Select Network Compartment
    description: The compartment in which to create all Network resources
    default: compartment_ocid

  region:
    type: oci:identity:region:name
    title: Region
    description: The region in which to create all resources
    required: true

  availability_domain_name_1:
    type: oci:identity:availabilitydomain:name
    dependsOn:
      compartmentId: compartment_ocid
    required: true
    default: 1
    title: Availability Domain for FortiGate-VM deployment
    description: Availability Domain

  license_type:
    type: enum
    required: true
    enum:
      - BYOL
      - PAYGO 2 OCPUs
      - PAYGO 4 OCPUs
      - PAYGO 8 OCPUs
      - PAYGO 16 OCPUs
      - PAYGO 24 OCPUs
    title: License Type for FortiGate-VM Installation
    description: Choose license type for this deployment

  ocpu_count:
    type: enum
    required: true
    dependsOn:
      vm_compute_shape
    enum:
      - 1
      - 2
      - 4
      - 8
      - 16
      - 24
    visible:
      or:
        - eq:
          - ${vm_compute_shape_arm}
          - "VM.Standard.A1.Flex"
        - eq:
          - ${vm_compute_shape_x64}
          - "VM.Standard.E4.Flex"
    title: Number of OCPU to allocate
    description: Number of OCPU to allocate

  memory_in_gbs:
    type: enum
    required: true
    dependsOn:
      vm_compute_shape
    default: 4
    enum:
      - 16
      - 32
      - 64
      - 128
      - 256
      - 384
    title: Memory (GB) - Default memory size is 16 times the OCPU count
    description: Memory size for Flex VM shape
    visible:
      or:
        - eq:
          - ${vm_compute_shape_arm}
          - "VM.Standard.A1.Flex"
        - eq:
          - ${vm_compute_shape_x64}
          - "VM.Standard.E4.Flex"

  cpu_type:
    type: enum
    required: true
    enum:
      - X64
      - ARM64
    title: CPU type
    description: CPU type

  fortios_version:
    type: enum
    required: true
    enum:
      - 7.6.3
      - 7.4.8
      - 7.2.11
      - 7.0.17
      - 6.4.13
    title: FortiOS version for FortiGate-VM
    description: Choose FortiOS version for installation

  vm_display_name:
    type: string
    required: true
    default: FortiGate Firewall
    title: Firewall Instance Name(s)
    description: The name of the Instance of Firewall

  vm_compute_shape_arm:
    title: "Firewall Compute Shape (ARM64)"
    type: enum
    required: true
    dependsOn:
      - cpu_type
    visible:
      eq:
        - ${cpu_type}
        - "ARM64"
    enum:
      - "VM.Standard.A1.Flex"

  vm_compute_shape_x64:
    title: "Firewall Compute Shape (X64)"
    type: enum
    required: true
    dependsOn:
      - cpu_type
    visible:
      eq:
        - ${cpu_type}
        - "X64"
    enum:
      - "VM.Standard2.2"
      - "VM.Standard2.4"
      - "VM.Standard2.8"
      - "VM.Standard2.16"
      - "VM.Standard2.24"
      - "VM.Standard.E4.Flex"

  vm_flex_shape_ocpus:
    visible:
      eq:
        - vm_compute_shape
        - "VM.Standard.E4.Flex"
    type: integer
    default: 4
    title: Flex Shape OCPUs
    minimum: 4
    maximum: 64
    required: false

  instance_launch_options_network_type:
    type: enum
    default: "SR-IOV (VFIO)"
    title: Select VNIC Type
    description: VNIC attachment type
    enum:
      - "PARAVIRTUALIZED"
      - "SR-IOV (VFIO)"
    required: true

  mp_listing_resource_version:
    type: string
    required: true
    description: Marketplace Listing package version

  # Network Type Options
  network_strategy:
    type: enum
    title: Network Strategy
    description: Create or use existing Network Stack (VCN and Subnets)
    enum:
      - "Create New VCN and Subnet"
      - "Use Existing VCN and Subnet"
    required: true
    default: "Create New VCN and Subnet"

  subnet_span:
    visible: #($network_strategy  == ""Create New VCN and Subnet"")
      eq:
        - network_strategy
        - "Create New VCN and Subnet"
    type: enum
    title: Subnet Span
    description: Choose between regional and AD specific subnets
    enum:
      - "Regional Subnet"
      - "AD Specific Subnet"
    required: true
    default: "Regional Subnet"

  vcn_display_name:
    visible: #($network_strategy  == ""Create New VCN and Subnet"")
      eq:
        - network_strategy
        - "Create New VCN and Subnet"
    type: string
    default: FortiGate-VCN
    required: true
    title: Firewall Virtual Cloud Network (VCN)
    description: The name of the new Virtual Cloud Network (VCN)

  vcn_id:
    visible: #($network_strategy  == "Use Existing VCN and Subnet")
      eq:
        - network_strategy
        - "Use Existing VCN and Subnet"
    type: oci:core:vcn:id
    dependsOn:
      compartmentId: compartment_ocid
    required: true
    title: Select Existing VCN
    description: An existing Virtual Cloud Network (VCN) in which to create the compute instances, network resources, and load balancers. If not specified, a new VCN is created.
  
  vcn_cidr_block:
    visible: #($network_strategy  == ""Create New VCN and Subnet"")
      eq:
        - network_strategy
        - "Create New VCN and Subnet"
    type: string
    required: true
    default: 192.168.0.0/16
    pattern: "^(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9]).(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9]).(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9]).(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\\/(3[0-2]|[1-2]?[0-9])$"
    title: Firewall VCN CIDR BLOCK
    description: The CIDR of the new Virtual Cloud Network (VCN). If you plan to peer this VCN with another VCN, the VCNs must not have overlapping CIDRs.

  management_subnet_id:
    visible: #($network_strategy  == "Use Existing VCN and Subnet")
      eq:
        - network_strategy
        - "Use Existing VCN and Subnet"
    type: oci:core:subnet:id
    dependsOn:
      vcnId: vcn_id
      compartmentId: compartment_ocid
    default: ""
    required: true
    title: Select Existing Management Subnet
    description: An existing management subnet to use for compute instances. This subnet must already be present in the chosen 

  management_subnet_display_name:
    visible: #($network_strategy  == ""Create New VCN and Subnet"")
      eq:
        - network_strategy
        - "Create New VCN and Subnet"
    type: string
    default: mgmt-subnet
    required: true
    title: Management Subnet
    description: The name of the new Management Subnet

  management_subnet_cidr_block:
    visible:
      - eq:
        - network_strategy
        - "Create New VCN and Subnet"
      - eq:
        - network_strategy
        - "Use Existing VCN and Subnet"
        title: Existing Management Subnet CIDR Block
        default: ""
        description: Edit Management Subnet CIDR based on your selection.
        type: string
        pattern: "^(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9]).(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9]).(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9]).(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\\/(3[0-2]|[1-2]?[0-9])$"
        required: true
    type: string
    pattern: "^(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9]).(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9]).(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9]).(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\\/(3[0-2]|[1-2]?[0-9])$"
    required: true
    default: "192.168.1.0/24"
    title: Management Subnet CIDR Block
    description: The CIDR of the new Subnet. The new subnet's CIDR should not overlap with any other subnet CIDRs.

  trust_subnet_id:
    visible: #($network_strategy  == "Use Existing VCN and Subnet")
      eq:
        - network_strategy
        - "Use Existing VCN and Subnet"
    type: oci:core:subnet:id
    dependsOn:
      vcnId: vcn_id
      compartmentId: compartment_ocid
    default: ""
    required: true
    title: Select Existing Trust Subnet
    description: An existing trust subnet to use traffic coming from trust. This subnet must already be present in the chosen VCN.

  trust_subnet_display_name:
    visible: #($network_strategy  == ""Create New VCN and Subnet"")
      eq:
        - network_strategy
        - "Create New VCN and Subnet"
    type: string
    default: trust-subnet
    required: true
    title: Trust Subnet
    description: The name of the new Trust Subnet

  trust_subnet_cidr_block:
    visible:
      - eq:
        - network_strategy
        - "Create New VCN and Subnet"
      - eq:
        - network_strategy
        - "Use Existing VCN and Subnet"
        title: Existing Trust Subnet CIDR Block
        default: ""
        description: Edit Trust Subnet CIDR based on your selection.
        type: string
        pattern: "^(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9]).(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9]).(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9]).(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\\/(3[0-2]|[1-2]?[0-9])$"
        required: true
    type: string
    pattern: "^(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9]).(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9]).(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9]).(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\\/(3[0-2]|[1-2]?[0-9])$"
    required: true
    default: "192.168.2.0/24"
    title: Trust Subnet CIDR Block
    description: The CIDR of the new Subnet. The new subnet's CIDR should not overlap with any other subnet CIDRs.

  vcn_dns_label:
    visible: #($network_strategy  == ""Create New VCN and Subnet"")
      eq:
        - network_strategy
        - "Create New VCN and Subnet"
    type: string
    required: true
    default: ha
    title: Firewall VCN DNS Label
    description: Firewall VCN DNS Label. Only letters and numbers, starting with a letter. 15 characters max.
  
  management_subnet_dns_label:
    visible: #($network_strategy  == ""Create New VCN and Subnet"")
      eq:
        - network_strategy
        - "Create New VCN and Subnet"
    type: string
    required: true
    default: management
    title: Managment Subnet DNS Label
    description: Managment Subnet DNS Label. Only letters and numbers, starting with a letter. 15 characters max.

  trust_subnet_dns_label:
    visible: #($network_strategy  == ""Create New VCN and Subnet"")
      eq:
        - network_strategy
        - "Create New VCN and Subnet"
    type: string
    required: true
    default: trust
    title: Trust Subnet DNS Label
    description: Trust subnet DNS Label. Only letters and numbers, starting with a letter. 15 characters max.

  use_existing_ip:
    type: enum
    title: Firewall Trust Interface Floating Cluster Public IP
    required: true
    enum:
      - "Create new IP"
      - "Add IP later"
    description: Create a permanent cluster IP or add one later

  igw_ocid:
    visible: #($network_strategy  == ""Create New VCN and Subnet"")
      eq:
        - network_strategy
        - "Use Existing VCN and Subnet"
    type: string
    required: true
    default: ""
    title: Existing Internet Gateway OCID
    description: Enter your existing Internet Gateway's OCID value

  nsg_whitelist_ip:
    type: string
    required: true
    default: 0.0.0.0/0
    title: Network Security Groups - Whitelisted IP
    description: "Ingress connection to FortiGate-VM whitelisted from IP (range). Enter 0.0.0.0/0 or <your IP>/32"

  nsg_display_name:
    type: string
    required: true
    default: cluster-security-group
    title: Network Security Group
    description: The name of the Network Security Group

  public_routetable_display_name:
    type: string
    required: true
    default: Trust-Route-Table
    title: Public Route Table
    description: The name of the Public Route Table

  private_routetable_display_name:
    type: string
    required: true
    default: Trust-Route-Table
    title: Trust Route Table
    description: The name of the Trust Route Table

  management_routetable_display_name:
    type: string
    required: true
    default: Management-Route-Table
    title: Management Route Table
    description: The name of the Management Route Table

  management_routetable_display_name_existing:
    visible: #($network_strategy  == ""Create New VCN and Subnet"")
      eq:
        - network_strategy
        - "Use Existing VCN and Subnet"
    type: string
    required: true
    default: Management-Route-Table-Existing
    title: Management Route Table Existing
    description: The name of the Management Route Table Existing

  trust_routetable_display_name_existing:
    visible: #($network_strategy  == ""Create New VCN and Subnet"")
      eq:
        - network_strategy
        - "Use Existing VCN and Subnet"
    type: string
    required: true
    default: Trust-Route-Table-Existing
    title: Trust Route Table Existing
    description: The name of the Trust Route Table Existing

  mgmt_private_ip:
    type: string
    default: 192.168.1.10
    required: true
    title: Primary Firewall Mgmt Interface IP 
    description: Primary Firewall Mgmt Interface Private IP

  trust_private_ip:
    type: string
    default: 192.168.2.10
    required: true
    title: Primary Firewall Trust Interface IP 
    description: Primary Firewall Trust Interface Private IP

  mgmt_subnet_gateway:
    type: string
    default: 192.168.1.1
    required: true
    title: Management Subnet Gateway
    description: Management Subnet Default Gateway IP

  trust_subnet_gateway:
    type: string
    default: 192.168.2.1
    required: true
    title: Trust Subnet Gateway
    description: Trust Subnet Default Gateway IP

  volume_size:
    visible: #($network_strategy  == ""Create New VCN and Subnet"")
      eq:
        - network_strategy
        - "Create New VCN and Subnet"
    type: string 
    default: 50
    required: true
    title: Firewall Volume Size
    description: Firewall VM Block Volume Attachment Size in GB

outputGroups:
  - title: "FortiGate Firewall Connection"
    outputs:
      - instance_public_ips
      - instance_private_ips
      - instance_id
      - instance_https_urls
      - cluster_ip

outputs:
  instance_https_urls:
    type: link
    title: Open FotiGate
    visible: true

  firewallA_instance_public_ips:
    type: link
    title: Firewall-A Instance Public IP
    visible: true

  firewallA_instance_private_ips:
    type: link
    title: Firewall-A Instance Private IP
    visible: true

  initial_instruction:
    type: string
    title: Initial Instruction
    visible: false

  subscription:
    type: string
    title: Subscription
    visible: false
